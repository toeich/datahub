package de.jworks.datahub.presentation.editors;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property;
import com.vaadin.data.fieldgroup.FieldGroup;
import com.vaadin.data.util.AbstractInMemoryContainer;
import com.vaadin.data.util.MethodProperty;
import com.vaadin.shared.ui.MarginInfo;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.Component;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.Panel;
import com.vaadin.ui.Table;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.util.ReflectTools;

import de.jworks.datahub.business.datasets.entity.Attribute;
import de.jworks.datahub.business.datasets.entity.Dataset;
import de.jworks.datahub.business.datasets.entity.DatasetGroup;
import de.jworks.datahub.business.datasets.entity.DatasetSchema;
import de.jworks.datahub.business.datasets.entity.Element;
import de.jworks.datahub.business.util.XMLUtil;

public class DatasetEditor extends CustomComponent {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	@AutoGenerated
	private VerticalLayout mainLayout;
	@AutoGenerated
	private HorizontalLayout buttons;
	@AutoGenerated
	private Button cancelButton;
	@AutoGenerated
	private Button okButton;
	@AutoGenerated
	private Panel panel;
	@AutoGenerated
	private VerticalLayout panelContent;
	
	public DatasetEditor(final Dataset dataset) {
		buildMainLayout();
		setCompositionRoot(mainLayout);
		
		DatasetGroup group = dataset.getGroup();
		DatasetSchema schema = group.getSchema();
		
		Document document = null;
		try {
			document = XMLUtil.parse(dataset.getContent());
		} catch (Exception e) {
			document = XMLUtil.parse("<" + schema.getRootElement().getName() + "/>");
		}
		
		processSingle(document, document.getDocumentElement(), schema.getRootElement(), panelContent);
		
		okButton.addClickListener(new ClickListener() {
			@Override
			public void buttonClick(ClickEvent event) {
				fireEvent(new SaveEvent(DatasetEditor.this, dataset));
			}
		});
		
		cancelButton.addClickListener(new ClickListener() {
			@Override
			public void buttonClick(ClickEvent event) {
				fireEvent(new SaveEvent(DatasetEditor.this, null));
			}
		});
	}

	private void process(Node parent, Element element, VerticalLayout container) {
		if (element.getMaxOccurs() == null || element.getMaxOccurs() > 1) {
			NodeList nodeList = XMLUtil.selectNodes(element.getName(), parent);
			processMultiple(parent, nodeList, element, container);
		} else {
			Node node = XMLUtil.selectNode(element.getName(), parent);
			if (node == null) {
				parent.appendChild(node = parent.getOwnerDocument().createElement(element.getName()));
			}
			processSingle(parent, node, element, container);
		}
	}

	private void processSingle(Node parent, Node node, Element element, VerticalLayout container) {
		VerticalLayout layout = new VerticalLayout();
		layout.setSpacing(true);

		if (element.getParent() != null) {
			HorizontalLayout header = new HorizontalLayout();
			header.setSpacing(true);

			Label name = new Label(element.getLabel());
			name.setStyleName("h2");
			header.addComponent(name);

			Button deleteButton = new Button();
			deleteButton.setCaption("Delete");
			deleteButton.setStyleName("link");
			header.addComponent(deleteButton);
			header.setComponentAlignment(deleteButton, Alignment.MIDDLE_LEFT);
			
			if (element.getMaxOccurs() == null || element.getMaxOccurs() > 1) {
				Button moveButton = new Button();
				moveButton.setCaption("Move");
				moveButton.setStyleName("link");
				header.addComponent(moveButton);
				header.setComponentAlignment(moveButton, Alignment.MIDDLE_LEFT);
			}

			layout.addComponent(header);
		}

		List<Attribute> attributes = element.getAttributes();
		if (attributes.size() > 0) {
			VerticalLayout attributesContainer = new VerticalLayout();
			attributesContainer.setSpacing(true);
			
			for (Attribute attribute : attributes) {
				TextField textField = new TextField();
				textField.setWidth("100%");
				textField.setCaption(attribute.getLabel());
				textField.setDescription(attribute.getDescription());
				textField.setNullRepresentation(null);
				textField.setPropertyDataSource(new MethodProperty<Object>(
						String.class, 
						node, 
						ReflectTools.findMethod(org.w3c.dom.Element.class, "getAttribute", String.class), 
						ReflectTools.findMethod(org.w3c.dom.Element.class, "setAttribute", String.class, String.class), 
						new Object[] { attribute.getName() }, 
						new Object[] { attribute.getName(), null }, 
						1));
				attributesContainer.addComponent(textField);
			}
			
			layout.addComponent(attributesContainer);
		}

		List<Element> elements = element.getElements();
		if (elements.size() > 0) {
			VerticalLayout elementsContainer = new VerticalLayout();
			elementsContainer.setMargin(new MarginInfo(false, false, false, true));
			elementsContainer.setSpacing(true);

			for (Element e : elements) {
				process(node, e, elementsContainer);
			}
			
			layout.addComponent(elementsContainer);
		}
		
		container.addComponent(layout);
	}

	private void processMultiple(Node parent, NodeList nodeList, Element element, VerticalLayout container) {
		List<Element> elements = element.getElements();
		if (elements.size() == 0) {
			processMultipleAsTable(parent, nodeList, element, container);
		} else {
			processMultipleAsGroup(parent, nodeList, element, container);
		}
	}

	private void processMultipleAsGroup(final Node parent, NodeList nodeList, final Element element, final VerticalLayout container) {
		final VerticalLayout layout = new VerticalLayout();
		layout.setSpacing(true);
		
		for (int i = 0; i < nodeList.getLength(); i++) {
			processSingle(parent, nodeList.item(i), element, layout);
		}
		
		final Button addButton = new Button();
		addButton.setStyleName("small");
		addButton.setCaption("Add " + element.getLabel());
		addButton.addClickListener(new ClickListener() {
			@Override
			public void buttonClick(ClickEvent event) {
				Node node = parent.getOwnerDocument().createElement(element.getName());
				Node ref = null; // FIXME
				parent.insertBefore(node, ref);
				processSingle(parent, node, element, layout);
				layout.addComponent(addButton);
			}
		});
		layout.addComponent(addButton);
		
		container.addComponent(layout);
	}

	private void processMultipleAsTable(final Node parent, final NodeList nodeList, final Element element, final VerticalLayout container) {
		VerticalLayout layout = new VerticalLayout();
		layout.setSpacing(true);
		
		HorizontalLayout header = new HorizontalLayout();
		header.setSpacing(true);
		
		Label name = new Label(element.getPluralLabel());
		name.setStyleName("h2");
		header.addComponent(name);
		
		Button addButton = new Button();
		addButton.setCaption("Add " + element.getLabel());
		addButton.setStyleName("link");
		addButton.addClickListener(new ClickListener() {
			@Override
			public void buttonClick(ClickEvent event) {
				Node node = parent.getOwnerDocument().createElement(element.getName());
				Node ref = null; // FIXME
				parent.insertBefore(node, ref);
			}
		});
		header.addComponent(addButton);
		header.setComponentAlignment(addButton, Alignment.MIDDLE_LEFT);
		
		layout.addComponent(header);
		
		Table table = new Table();
		table.setWidth("100%");
		table.setHeight("200px");
		for (Attribute attribute : element.getAttributes()) {
			table.addContainerProperty(attribute.getName(), String.class, null, attribute.getLabel(), null, null);
		}
		layout.addComponent(table);
		
		container.addComponent(layout);
	}
	
	public static class ElementContainer implements Container {

		@Override
		public Item getItem(Object itemId) {
			// TODO Auto-generated method stub
			return null;
		}

		@Override
		public Collection<?> getContainerPropertyIds() {
			// TODO Auto-generated method stub
			return null;
		}

		@Override
		public Collection<?> getItemIds() {
			// TODO Auto-generated method stub
			return null;
		}

		@Override
		public Property getContainerProperty(Object itemId, Object propertyId) {
			// TODO Auto-generated method stub
			return null;
		}

		@Override
		public Class<?> getType(Object propertyId) {
			// TODO Auto-generated method stub
			return null;
		}

		@Override
		public int size() {
			// TODO Auto-generated method stub
			return 0;
		}

		@Override
		public boolean containsId(Object itemId) {
			// TODO Auto-generated method stub
			return false;
		}

		@Override
		public Item addItem(Object itemId) throws UnsupportedOperationException {
			throw new UnsupportedOperationException();
		}

		@Override
		public Object addItem() throws UnsupportedOperationException {
			throw new UnsupportedOperationException();
		}

		@Override
		public boolean removeItem(Object itemId) throws UnsupportedOperationException {
			throw new UnsupportedOperationException();
		}

		@Override
		public boolean addContainerProperty(Object propertyId, Class<?> type,Object defaultValue) throws UnsupportedOperationException {
			throw new UnsupportedOperationException();
		}

		@Override
		public boolean removeContainerProperty(Object propertyId) throws UnsupportedOperationException {
			throw new UnsupportedOperationException();
		}

		@Override
		public boolean removeAllItems() throws UnsupportedOperationException {
			throw new UnsupportedOperationException();
		}
		
	}
	
	public static class NodeContainer extends AbstractInMemoryContainer<Node, String, ElementItem> {
		
		private Node parent;
		
		private Element element;

		public NodeContainer(Node parent, Element element) {
			this.parent = parent;
			this.element = element;
		}

		@Override
		public Collection<?> getContainerPropertyIds() {
			List<String> propertyIds = new ArrayList<String>();
			for (Attribute attribute : element.getAttributes()) {
				propertyIds.add(attribute.getName());
			}
			return propertyIds;
		}

		@Override
		public Property<?> getContainerProperty(Object itemId, Object propertyId) {
			return getUnfilteredItem(itemId).getItemProperty(propertyId);
		}

		@Override
		public Class<?> getType(Object propertyId) {
			return String.class;
		}

		@Override
		protected ElementItem getUnfilteredItem(Object itemId) {
			return new ElementItem((Node) itemId);
		}
		
	}
	
	@SuppressWarnings("rawtypes")
	public static class ElementItem implements Item {

		private Node node;
		
		public ElementItem(Node node) {
			this.node = node;
		}

		@Override
		public Collection<?> getItemPropertyIds() {
			return null;
		}
		
		@Override
		public boolean addItemProperty(Object id, Property property) throws UnsupportedOperationException {
			return false;
		}
		
		@Override
		public boolean removeItemProperty(Object id) throws UnsupportedOperationException {
			return false;
		}
		
		@Override
		public Property getItemProperty(Object id) {
			try {
				return new MethodProperty<Object>(
						String.class, 
						node, 
						org.w3c.dom.Element.class.getMethod("getAttribute", String.class), 
						org.w3c.dom.Element.class.getMethod("setAttribute", String.class, String.class), 
						new Object[] { id }, 
						new Object[] { id, null }, 
						1);
			} catch (Exception e) {
				return null;
			}
		}

	}

	public static class SaveEvent extends Event {
		
		private Dataset dataset;

		public SaveEvent(Component source, Dataset dataset) {
			super(source);
			
			this.dataset = dataset;
		}
		
		public Dataset getDataset() {
			return dataset;
		}
		
	}
	
	public interface SaveListener extends Serializable {
		
		public void save(SaveEvent event);
		
	}

	public void addSaveListener(SaveListener listener) {
		addListener(SaveEvent.class, listener, ReflectTools.findMethod(SaveListener.class, "save", SaveEvent.class));
	}
	
	public void removeSaveListener(SaveListener listener) {
		removeListener(SaveEvent.class, listener, ReflectTools.findMethod(SaveListener.class, "save", SaveEvent.class));
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("100%");
		mainLayout.setMargin(false);
		mainLayout.setSpacing(true);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("100.0%");
		
		// panel
		panel = buildPanel();
		mainLayout.addComponent(panel);
		mainLayout.setExpandRatio(panel, 1.0f);
		
		// buttons
		buttons = buildButtons();
		mainLayout.addComponent(buttons);
		mainLayout.setComponentAlignment(buttons, new Alignment(6));
		
		return mainLayout;
	}

	@AutoGenerated
	private Panel buildPanel() {
		// common part: create layout
		panel = new Panel();
		panel.setStyleName("light");
		panel.setImmediate(false);
		panel.setWidth("100.0%");
		panel.setHeight("100.0%");
		
		// panelContent
		panelContent = new VerticalLayout();
		panelContent.setImmediate(false);
		panelContent.setWidth("100.0%");
		panelContent.setHeight("100.0%");
		panelContent.setMargin(true);
		panel.setContent(panelContent);
		
		return panel;
	}

	@AutoGenerated
	private HorizontalLayout buildButtons() {
		// common part: create layout
		buttons = new HorizontalLayout();
		buttons.setImmediate(false);
		buttons.setWidth("-1px");
		buttons.setHeight("-1px");
		buttons.setMargin(true);
		buttons.setSpacing(true);
		
		// okButton
		okButton = new Button();
		okButton.setStyleName("primary");
		okButton.setCaption("OK");
		okButton.setImmediate(true);
		okButton.setWidth("-1px");
		okButton.setHeight("-1px");
		buttons.addComponent(okButton);
		
		// cancelButton
		cancelButton = new Button();
		cancelButton.setCaption("Cancel");
		cancelButton.setImmediate(true);
		cancelButton.setWidth("-1px");
		cancelButton.setHeight("-1px");
		buttons.addComponent(cancelButton);
		
		return buttons;
	}

}
